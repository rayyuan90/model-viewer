{"version":3,"file":"environment-spec.js","sourceRoot":"","sources":["../../../src/test/features/environment-spec.js"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright 2018 Google Inc. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {EnvironmentMixin} from '../../features/environment.js';\nimport ModelViewerElementBase, {$scene} from '../../model-viewer-base.js';\nimport {timePasses, waitForEvent} from '../helpers.js';\n\nconst expect = chai.expect;\nconst BG_IMAGE_URL = './examples/assets/equirectangular.png';\nconst MODEL_URL = './examples/assets/reflective-sphere.gltf';\n\nconst skysphereUsingMap = (scene, url) => scene.skysphere.material.map &&\n    scene.skysphere.material.map.name === url &&\n    scene.skysphere.material.color.getHexString() === 'ffffff';\n\nconst skysphereUsingColor =\n    (scene, hex) => {\n      const {color, map} = scene.skysphere.material;\n      // Invert gamma correct to match passed in hex\n      const gammaCorrectedColor = color.clone().convertLinearToGamma(2.2);\n\n      return map == null && gammaCorrectedColor.getHexString() === hex;\n    }\n\nconst modelUsingEnvmap = (scene, url) => {\n  let found = false;\n  scene.model.traverse(object => {\n    if (object && object.material && object.material.envMap &&\n        object.material.envMap.name === url) {\n      found = true;\n    }\n  });\n  return found;\n};\n\nconst waitForEnvmap = (model, mapName) => waitForEvent(\n    model, 'envmap-change', e => e.value ? e.value.name === mapName : false);\n\nconst waitForLoadAndEnvmap = (scene, element, mapName) => Promise.all(\n    [waitForEvent(element, 'load'), waitForEnvmap(scene.model, mapName)]);\n\nsuite('ModelViewerElementBase with EnvironmentMixin', () => {\n  let nextId = 0;\n  let tagName;\n  let ModelViewerElement;\n  let element;\n  let scene;\n\n  setup(() => {\n    tagName = `model-viewer-environment-${nextId++}`;\n    ModelViewerElement = class extends EnvironmentMixin\n    (ModelViewerElementBase) {\n      static get is() {\n        return tagName;\n      }\n    };\n    customElements.define(tagName, ModelViewerElement);\n    element = new ModelViewerElement();\n    scene = element[$scene];\n  });\n\n  teardown(() => element.remove());\n\n  test(\n      'has default skysphere if no background-image or background-color',\n      () => {\n        expect(skysphereUsingColor(scene, 'ffffff')).to.be.equal(true);\n      });\n\n  test(\n      'has default skysphere if no background-image or background-color when in DOM',\n      async () => {\n        document.body.appendChild(element);\n        await timePasses();\n        expect(skysphereUsingColor(scene, 'ffffff')).to.be.equal(true);\n      });\n\n  suite('with a background-image property', () => {\n    suite('and a src property', () => {\n      setup(async () => {\n        let onLoad = waitForLoadAndEnvmap(scene, element, BG_IMAGE_URL);\n        element.src = MODEL_URL;\n        element.backgroundImage = BG_IMAGE_URL;\n        await onLoad;\n      });\n\n      test('displays skysphere with the correct map', async function() {\n        expect(skysphereUsingMap(scene, element.backgroundImage)).to.be.ok;\n      });\n\n      test('applies the image as an environment map', async function() {\n        expect(modelUsingEnvmap(scene, element.backgroundImage)).to.be.ok;\n      });\n    });\n  });\n\n  suite('with a background-color property', () => {\n    suite('and a src property', () => {\n      setup(async () => {\n        let onLoad = waitForLoadAndEnvmap(scene, element, 'Generated');\n        element.src = MODEL_URL;\n        element.backgroundColor = '#ff0077';\n        await onLoad;\n      });\n\n      test('displays skysphere with the correct color', async function() {\n        expect(skysphereUsingColor(scene, 'ff0077')).to.be.ok;\n      });\n\n      test('applies a generated environment map on model', async function() {\n        expect(modelUsingEnvmap(scene, 'Generated')).to.be.ok;\n      });\n\n      test(\n          'displays skysphere with correct color after attaching to DOM',\n          async function() {\n            document.body.appendChild(element);\n            await timePasses();\n            expect(skysphereUsingColor(scene, 'ff0077')).to.be.ok;\n          });\n    });\n  });\n\n  suite('with background-color and background-image properties', () => {\n    setup(async () => {\n      let onLoad = waitForLoadAndEnvmap(scene, element, BG_IMAGE_URL);\n      element.setAttribute('src', MODEL_URL);\n      element.setAttribute('background-color', '#ff0077');\n      element.setAttribute('background-image', BG_IMAGE_URL);\n      await onLoad;\n    });\n\n    test('displays skysphere with background-image', async function() {\n      expect(skysphereUsingMap(scene, element.backgroundImage)).to.be.ok;\n    });\n\n    test('applies background-image envmap on model', async function() {\n      expect(modelUsingEnvmap(scene, element.backgroundImage)).to.be.ok;\n    });\n\n    suite('and background-image subsequently removed', () => {\n      setup(async () => {\n        let envmapChanged = waitForEnvmap(scene.model, 'Generated');\n        element.removeAttribute('background-image');\n        await envmapChanged;\n      });\n\n      test('displays skysphere with background-color', async function() {\n        expect(skysphereUsingColor(scene, 'ff0077')).to.be.ok;\n      });\n\n      test('reapplies generated envmap on model', async function() {\n        expect(modelUsingEnvmap(scene, 'Generated')).to.be.ok;\n      });\n    });\n  });\n});\n"]}